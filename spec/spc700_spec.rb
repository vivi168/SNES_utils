require 'spec_helper'
require 'snes_utils'

describe SnesUtils::MiniAssembler do
  RSpec::Support::ObjectFormatter.default_instance.max_formatted_output_length = 10000000000000000

  let(:mini_asm) { SnesUtils::MiniAssembler.new }
  let(:memory) do
    ["00", "01", "02", "12", "03", "12", "34", "04", "12", "05", "34", "12", "06", "07", "12", "08",
    "12", "09", "34", "12", "0A", "A5", "91", "0B", "12", "0C", "34", "12", "0D", "0E", "34", "12",
    "0F", "10", "12", "11", "12", "12", "13", "12", "34", "14", "12", "15", "34", "12", "16", "34",
    "12", "17", "12", "18", "34", "12", "19", "1A", "12", "1B", "12", "1C", "1D", "1E", "34", "12",
    "1F", "34", "12", "20", "21", "22", "12", "23", "12", "34", "24", "12", "25", "34", "12", "26",
    "27", "12", "28", "12", "29", "34", "12", "2A", "A5", "91", "2B", "12", "2C", "34", "12", "2D",
    "2E", "12", "34", "2F", "12", "30", "12", "31", "32", "12", "33", "12", "34", "34", "12", "35",
    "34", "12", "36", "34", "12", "37", "12", "38", "34", "12", "39", "3A", "12", "3B", "12", "3C",
    "3D", "3E", "12", "3F", "34", "12", "40", "41", "42", "12", "43", "12", "34", "44", "12", "45",
    "34", "12", "46", "47", "12", "48", "12", "49", "34", "12", "4A", "A5", "91", "4B", "12", "4C",
    "34", "12", "4D", "4E", "34", "12", "4F", "12", "50", "12", "51", "52", "12", "53", "12", "34",
    "54", "12", "55", "34", "12", "56", "34", "12", "57", "12", "58", "34", "12", "59", "5A", "12",
    "5B", "12", "5C", "5D", "5E", "34", "12", "5F", "34", "12", "60", "61", "62", "12", "63", "12",
    "34", "64", "12", "65", "34", "12", "66", "67", "12", "68", "12", "69", "34", "12", "6A", "A5",
    "91", "6B", "12", "6C", "34", "12", "6D", "6E", "12", "34", "6F", "70", "12", "71", "72", "12",
    "73", "12", "34", "74", "12", "75", "34", "12", "76", "34", "12", "77", "12", "78", "34", "12",
    "79", "7A", "12", "7B", "12", "7C", "7D", "7E", "12", "7F", "80", "81", "82", "12", "83", "12",
    "34", "84", "12", "85", "34", "12", "86", "87", "12", "88", "12", "89", "34", "12", "8A", "A5",
    "91", "8B", "12", "8C", "34", "12", "8D", "12", "8E", "8F", "34", "12", "90", "12", "91", "92",
    "12", "93", "12", "34", "94", "12", "95", "34", "12", "96", "34", "12", "97", "12", "98", "34",
    "12", "99", "9A", "12", "9B", "12", "9C", "9D", "9E", "9F", "A0", "A1", "A2", "12", "A3", "12",
    "34", "A4", "12", "A5", "34", "12", "A6", "A7", "12", "A8", "12", "A9", "34", "12", "AA", "A5",
    "91", "AB", "12", "AC", "34", "12", "AD", "12", "AE", "AF", "B0", "12", "B1", "B2", "12", "B3",
    "12", "34", "B4", "12", "B5", "34", "12", "B6", "34", "12", "B7", "12", "B8", "34", "12", "B9",
    "BA", "12", "BB", "12", "BC", "BD", "BE", "BF", "C0", "C1", "C2", "12", "C3", "12", "34", "C4",
    "12", "C5", "34", "12", "C6", "C7", "12", "C8", "12", "C9", "34", "12", "CA", "A5", "91", "CB",
    "12", "CC", "34", "12", "CD", "12", "CE", "CF", "D0", "12", "D1", "D2", "12", "D3", "12", "34",
    "D4", "12", "D5", "34", "12", "D6", "34", "12", "D7", "12", "D8", "12", "D9", "12", "DA", "12",
    "DB", "12", "DC", "DD", "DE", "12", "34", "DF", "E0", "E1", "E2", "12", "E3", "12", "34", "E4",
    "12", "E5", "34", "12", "E6", "E7", "12", "E8", "12", "E9", "34", "12", "EA", "A5", "91", "EB",
    "12", "EC", "34", "12", "ED", "EE", "EF", "F0", "12", "F1", "F2", "12", "F3", "12", "34", "F4",
    "12", "F5", "34", "12", "F6", "34", "12", "F7", "12", "F8", "12", "F9", "12", "FA", "34", "12",
    "FB", "12", "FC", "FD", "FE", "12", "FF"]
  end

  describe 'when assembling' do
    let(:file) { 'spec/fixtures/spc700.asm' }
    before { mini_asm.read(file) }

    it 'sets memory correctly' do
      expect(mini_asm.instance_variable_get(:@memory)).to eq memory
    end
  end

  describe 'when disassembling' do
    subject { mini_asm.disassemble_range(0, 256) }

    before do
      mini_asm.instance_variable_set(:@memory, memory)
      mini_asm.instance_variable_set(:@cpu, :spc700)
    end

    it 'disassembles correctly' do
      expect(subject).to eq [
        "00/0000: 00                    NOP",
        "00/0001: 01                    TCALL 0",
        "00/0002: 02 12                 SET1  12.0",
        "00/0004: 03 12 34              BBS   12.0,003B {+34}",
        "00/0007: 04 12                 OR    A,12",
        "00/0009: 05 34 12              OR    A,!1234",
        "00/000C: 06                    OR    A,(X)",
        "00/000D: 07 12                 OR    A,[12+X]",
        "00/000F: 08 12                 OR    A,#12",
        "00/0011: 09 34 12              OR    12<d>,34<s>",
        "00/0014: 0A A5 91              OR1   C,1234.5",
        "00/0017: 0B 12                 ASL   12",
        "00/0019: 0C 34 12              ASL   !1234",
        "00/001C: 0D                    PUSH  PSW",
        "00/001D: 0E 34 12              TSET1 !1234",
        "00/0020: 0F                    BRK",
        "00/0021: 10 12                 BPL   0035 {+12}",
        "00/0023: 11                    TCALL 1",
        "00/0024: 12 12                 CLR1  12.0",
        "00/0026: 13 12 34              BBC   12.0,005D {+34}",
        "00/0029: 14 12                 OR    A,12+X",
        "00/002B: 15 34 12              OR    A,!1234+X",
        "00/002E: 16 34 12              OR    A,!1234+Y",
        "00/0031: 17 12                 OR    A,[12]+Y",
        "00/0033: 18 34 12              OR    12,#34",
        "00/0036: 19                    OR    (X),(Y)",
        "00/0037: 1A 12                 DECW  12",
        "00/0039: 1B 12                 ASL   12+X",
        "00/003B: 1C                    ASL   A",
        "00/003C: 1D                    DEC   X",
        "00/003D: 1E 34 12              CMP   X,!1234",
        "00/0040: 1F 34 12              JMP   [!1234+X]",
        "00/0043: 20                    CLRP",
        "00/0044: 21                    TCALL 2",
        "00/0045: 22 12                 SET1  12.1",
        "00/0047: 23 12 34              BBS   12.1,007E {+34}",
        "00/004A: 24 12                 AND   A,12",
        "00/004C: 25 34 12              AND   A,!1234",
        "00/004F: 26                    AND   A,(X)",
        "00/0050: 27 12                 AND   A,[12+X]",
        "00/0052: 28 12                 AND   A,#12",
        "00/0054: 29 34 12              AND   12<d>,34<s>",
        "00/0057: 2A A5 91              OR1   C,/1234.5",
        "00/005A: 2B 12                 ROL   12",
        "00/005C: 2C 34 12              ROL   !1234",
        "00/005F: 2D                    PUSH  A",
        "00/0060: 2E 12 34              CBNE  12,0097 {+34}",
        "00/0063: 2F 12                 BRA   0077 {+12}",
        "00/0065: 30 12                 BMI   0079 {+12}",
        "00/0067: 31                    TCALL 3",
        "00/0068: 32 12                 CLR1  12.1",
        "00/006A: 33 12 34              BBC   12.1,00A1 {+34}",
        "00/006D: 34 12                 AND   A,12+X",
        "00/006F: 35 34 12              AND   A,!1234+X",
        "00/0072: 36 34 12              AND   A,!1234+Y",
        "00/0075: 37 12                 AND   A,[12]+Y",
        "00/0077: 38 34 12              AND   12,#34",
        "00/007A: 39                    AND   (X),(Y)",
        "00/007B: 3A 12                 INCW  12",
        "00/007D: 3B 12                 ROL   12+X",
        "00/007F: 3C                    ROL   A",
        "00/0080: 3D                    INC   X",
        "00/0081: 3E 12                 CMP   X,12",
        "00/0083: 3F 34 12              CALL  !1234",
        "00/0086: 40                    SETP",
        "00/0087: 41                    TCALL 4",
        "00/0088: 42 12                 SET1  12.2",
        "00/008A: 43 12 34              BBS   12.2,00C1 {+34}",
        "00/008D: 44 12                 EOR   A,12",
        "00/008F: 45 34 12              EOR   A,!1234",
        "00/0092: 46                    EOR   A,(X)",
        "00/0093: 47 12                 EOR   A,[12+X]",
        "00/0095: 48 12                 EOR   A,#12",
        "00/0097: 49 34 12              EOR   12<d>,34<s>",
        "00/009A: 4A A5 91              AND1  C,1234.5",
        "00/009D: 4B 12                 LSR   12",
        "00/009F: 4C 34 12              LSR   !1234",
        "00/00A2: 4D                    PUSH  X",
        "00/00A3: 4E 34 12              TCLR1 !1234",
        "00/00A6: 4F 12                 PCALL 12",
        "00/00A8: 50 12                 BVC   00BC {+12}",
        "00/00AA: 51                    TCALL 5",
        "00/00AB: 52 12                 CLR1  12.2",
        "00/00AD: 53 12 34              BBC   12.2,00E4 {+34}",
        "00/00B0: 54 12                 EOR   A,12+X",
        "00/00B2: 55 34 12              EOR   A,!1234+X",
        "00/00B5: 56 34 12              EOR   A,!1234+Y",
        "00/00B8: 57 12                 EOR   A,[12]+Y",
        "00/00BA: 58 34 12              EOR   12,#34",
        "00/00BD: 59                    EOR   (X),(Y)",
        "00/00BE: 5A 12                 CMPW  YA,12",
        "00/00C0: 5B 12                 LSR   12+X",
        "00/00C2: 5C                    LSR   A",
        "00/00C3: 5D                    MOV   X,A",
        "00/00C4: 5E 34 12              CMP   Y,!1234",
        "00/00C7: 5F 34 12              JMP   !1234",
        "00/00CA: 60                    CLRC",
        "00/00CB: 61                    TCALL 6",
        "00/00CC: 62 12                 SET1  12.3",
        "00/00CE: 63 12 34              BBS   12.3,0105 {+34}",
        "00/00D1: 64 12                 CMP   A,12",
        "00/00D3: 65 34 12              CMP   A,!1234",
        "00/00D6: 66                    CMP   A,(X)",
        "00/00D7: 67 12                 CMP   A,[12+X]",
        "00/00D9: 68 12                 CMP   A,#12",
        "00/00DB: 69 34 12              CMP   12<d>,34<s>",
        "00/00DE: 6A A5 91              AND1  C,/1234.5",
        "00/00E1: 6B 12                 ROR   12",
        "00/00E3: 6C 34 12              ROR   !1234",
        "00/00E6: 6D                    PUSH  Y",
        "00/00E7: 6E 12 34              DBNZ  12,011E {+34}",
        "00/00EA: 6F                    RET",
        "00/00EB: 70 12                 BVS   00FF {+12}",
        "00/00ED: 71                    TCALL 7",
        "00/00EE: 72 12                 CLR1  12.3",
        "00/00F0: 73 12 34              BBC   12.3,0127 {+34}",
        "00/00F3: 74 12                 CMP   A,12+X",
        "00/00F5: 75 34 12              CMP   A,!1234+X",
        "00/00F8: 76 34 12              CMP   A,!1234+Y",
        "00/00FB: 77 12                 CMP   A,[12]+Y",
        "00/00FD: 78 34 12              CMP   12,#34",
        "00/0100: 79                    CMP   (X),(Y)",
        "00/0101: 7A 12                 ADDW  YA,12",
        "00/0103: 7B 12                 ROR   12+X",
        "00/0105: 7C                    ROR   A",
        "00/0106: 7D                    MOV   A,X",
        "00/0107: 7E 12                 CMP   Y,12",
        "00/0109: 7F                    RETI",
        "00/010A: 80                    SETC",
        "00/010B: 81                    TCALL 8",
        "00/010C: 82 12                 SET1  12.4",
        "00/010E: 83 12 34              BBS   12.4,0145 {+34}",
        "00/0111: 84 12                 ADC   A,12",
        "00/0113: 85 34 12              ADC   A,!1234",
        "00/0116: 86                    ADC   A,(X)",
        "00/0117: 87 12                 ADC   A,[12+X]",
        "00/0119: 88 12                 ADC   A,#12",
        "00/011B: 89 34 12              ADC   12<d>,34<s>",
        "00/011E: 8A A5 91              EOR1  C,1234.5",
        "00/0121: 8B 12                 DEC   12",
        "00/0123: 8C 34 12              DEC   !1234",
        "00/0126: 8D 12                 MOV   Y,#12",
        "00/0128: 8E                    POP   PSW",
        "00/0129: 8F 34 12              MOV   12,#34",
        "00/012C: 90 12                 BCC   0140 {+12}",
        "00/012E: 91                    TCALL 9",
        "00/012F: 92 12                 CLR1  12.4",
        "00/0131: 93 12 34              BBC   12.4,0168 {+34}",
        "00/0134: 94 12                 ADC   A,12+X",
        "00/0136: 95 34 12              ADC   A,!1234+X",
        "00/0139: 96 34 12              ADC   A,!1234+Y",
        "00/013C: 97 12                 ADC   A,[12]+Y",
        "00/013E: 98 34 12              ADC   12,#34",
        "00/0141: 99                    ADC   (X),(Y)",
        "00/0142: 9A 12                 SUBW  YA,12",
        "00/0144: 9B 12                 DEC   12+X",
        "00/0146: 9C                    DEC   A",
        "00/0147: 9D                    MOV   X,SP",
        "00/0148: 9E                    DIV   YA,X",
        "00/0149: 9F                    XCN   A",
        "00/014A: A0                    EI",
        "00/014B: A1                    TCALL 10",
        "00/014C: A2 12                 SET1  12.5",
        "00/014E: A3 12 34              BBS   12.5,0185 {+34}",
        "00/0151: A4 12                 SBC   A,12",
        "00/0153: A5 34 12              SBC   A,!1234",
        "00/0156: A6                    SBC   A,(X)",
        "00/0157: A7 12                 SBC   A,[12+X]",
        "00/0159: A8 12                 SBC   A,#12",
        "00/015B: A9 34 12              SBC   12<d>,34<s>",
        "00/015E: AA A5 91              MOV1  C,1234.5",
        "00/0161: AB 12                 INC   12",
        "00/0163: AC 34 12              INC   !1234",
        "00/0166: AD 12                 CMP   Y,#12",
        "00/0168: AE                    POP   A",
        "00/0169: AF                    MOV   (X)+,A",
        "00/016A: B0 12                 BCS   017E {+12}",
        "00/016C: B1                    TCALL 11",
        "00/016D: B2 12                 CLR1  12.5",
        "00/016F: B3 12 34              BBC   12.5,01A6 {+34}",
        "00/0172: B4 12                 SBC   A,12+X",
        "00/0174: B5 34 12              SBC   A,!1234+X",
        "00/0177: B6 34 12              SBC   A,!1234+Y",
        "00/017A: B7 12                 SBC   A,[12]+Y",
        "00/017C: B8 34 12              SBC   12,#34",
        "00/017F: B9                    SBC   (X),(Y)",
        "00/0180: BA 12                 MOVW  YA,12",
        "00/0182: BB 12                 INC   12+X",
        "00/0184: BC                    INC   A",
        "00/0185: BD                    MOV   SP,X",
        "00/0186: BE                    DAS   A",
        "00/0187: BF                    MOV   A,(X)+",
        "00/0188: C0                    DI",
        "00/0189: C1                    TCALL 12",
        "00/018A: C2 12                 SET1  12.6",
        "00/018C: C3 12 34              BBS   12.6,01C3 {+34}",
        "00/018F: C4 12                 MOV   12,A",
        "00/0191: C5 34 12              MOV   !1234,A",
        "00/0194: C6                    MOV   (X),A",
        "00/0195: C7 12                 MOV   [12+X],A",
        "00/0197: C8 12                 CMP   X,#12",
        "00/0199: C9 34 12              MOV   !1234,X",
        "00/019C: CA A5 91              MOV1  1234.5,C",
        "00/019F: CB 12                 MOV   12,Y",
        "00/01A1: CC 34 12              MOV   !1234,Y",
        "00/01A4: CD 12                 MOV   X,#12",
        "00/01A6: CE                    POP   X",
        "00/01A7: CF                    MUL   YA",
        "00/01A8: D0 12                 BNE   01BC {+12}",
        "00/01AA: D1                    TCALL 13",
        "00/01AB: D2 12                 CLR1  12.6",
        "00/01AD: D3 12 34              BBC   12.6,01E4 {+34}",
        "00/01B0: D4 12                 MOV   12+X,A",
        "00/01B2: D5 34 12              MOV   !1234+X,A",
        "00/01B5: D6 34 12              MOV   !1234+Y,A",
        "00/01B8: D7 12                 MOV   [12]+Y,A",
        "00/01BA: D8 12                 MOV   12,X",
        "00/01BC: D9 12                 MOV   12+Y,X",
        "00/01BE: DA 12                 MOVW  12,YA",
        "00/01C0: DB 12                 MOV   12+X,Y",
        "00/01C2: DC                    DEC   Y",
        "00/01C3: DD                    MOV   A,Y",
        "00/01C4: DE 12 34              CBNE  12+X,01FB {+34}",
        "00/01C7: DF                    DAA   A",
        "00/01C8: E0                    CLRV",
        "00/01C9: E1                    TCALL 14",
        "00/01CA: E2 12                 SET1  12.7",
        "00/01CC: E3 12 34              BBS   12.7,0203 {+34}",
        "00/01CF: E4 12                 MOV   A,12",
        "00/01D1: E5 34 12              MOV   A,!1234",
        "00/01D4: E6                    MOV   A,(X)",
        "00/01D5: E7 12                 MOV   A,[12+X]",
        "00/01D7: E8 12                 MOV   A,#12",
        "00/01D9: E9 34 12              MOV   X,!1234",
        "00/01DC: EA A5 91              NOT1  1234.5",
        "00/01DF: EB 12                 MOV   Y,12",
        "00/01E1: EC 34 12              MOV   Y,!1234",
        "00/01E4: ED                    NOTC",
        "00/01E5: EE                    POP   Y",
        "00/01E6: EF                    SLEEP",
        "00/01E7: F0 12                 BEQ   01FB {+12}",
        "00/01E9: F1                    TCALL 15",
        "00/01EA: F2 12                 CLR1  12.7",
        "00/01EC: F3 12 34              BBC   12.7,0223 {+34}",
        "00/01EF: F4 12                 MOV   A,12+X",
        "00/01F1: F5 34 12              MOV   A,!1234+X",
        "00/01F4: F6 34 12              MOV   A,!1234+Y",
        "00/01F7: F7 12                 MOV   A,[12]+Y",
        "00/01F9: F8 12                 MOV   X,12",
        "00/01FB: F9 12                 MOV   X,12+Y",
        "00/01FD: FA 34 12              MOV   12<d>,34<s>",
        "00/0200: FB 12                 MOV   Y,12+X",
        "00/0202: FC                    INC   Y",
        "00/0203: FD                    MOV   Y,A",
        "00/0204: FE 12                 DBNZ  Y,0218 {+12}",
        "00/0206: FF                    STOP"
      ]
    end
  end
end