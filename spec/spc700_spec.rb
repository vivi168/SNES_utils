require 'spec_helper'
require 'snes_utils'

describe SnesUtils::MiniAssembler do
let(:mini_asm) { SnesUtils::MiniAssembler.new }
  describe 'when assembling' do
  end

  describe 'when disassembling' do
    subject { mini_asm.disassemble_range(0, count) }

    let(:count) { 256 }
    let(:memory) do
      ["00", "01", "02", "12", "03", "12", "34", "04", "12", "05", "34", "12", "06", "07", "12", "08",
      "12", "09", "34", "12", "0a", "a5", "91", "0b", "12", "0c", "34", "12", "0d", "0e", "34", "12",
      "0f", "10", "12", "11", "12", "12", "13", "12", "34", "14", "12", "15", "34", "12", "16", "34",
      "12", "17", "12", "18", "34", "12", "19", "1a", "12", "1b", "12", "1c", "1d", "1e", "34", "12",
      "1f", "34", "12", "20", "21", "22", "12", "23", "12", "34", "24", "12", "25", "34", "12", "26",
      "27", "12", "28", "12", "29", "34", "12", "2a", "a5", "91", "2b", "12", "2c", "34", "12", "2d",
      "2e", "12", "34", "2f", "12", "30", "12", "31", "32", "12", "33", "12", "34", "34", "12", "35",
      "34", "12", "36", "34", "12", "37", "12", "38", "34", "12", "39", "3a", "12", "3b", "12", "3c",
      "3d", "3e", "12", "3f", "34", "12", "40", "41", "42", "12", "43", "12", "34", "44", "12", "45",
      "34", "12", "46", "47", "12", "48", "12", "49", "34", "12", "4a", "a5", "91", "4b", "12", "4c",
      "34", "12", "4d", "4e", "34", "12", "4f", "12", "50", "12", "51", "52", "12", "53", "12", "34",
      "54", "12", "55", "34", "12", "56", "34", "12", "57", "12", "58", "34", "12", "59", "5a", "12",
      "5b", "12", "5c", "5d", "5e", "34", "12", "5f", "34", "12", "60", "61", "62", "12", "63", "12",
      "34", "64", "12", "65", "34", "12", "66", "67", "12", "68", "12", "69", "34", "12", "6a", "a5",
      "91", "6b", "12", "6c", "34", "12", "6d", "6e", "12", "34", "6f", "70", "12", "71", "72", "12",
      "73", "12", "34", "74", "12", "75", "34", "12", "76", "34", "12", "77", "12", "78", "34", "12",
      "79", "7a", "12", "7b", "12", "7c", "7d", "7e", "12", "7f", "80", "81", "82", "12", "83", "12",
      "34", "84", "12", "85", "34", "12", "86", "87", "12", "88", "12", "89", "34", "12", "8a", "a5",
      "91", "8b", "12", "8c", "34", "12", "8d", "12", "8e", "8f", "34", "12", "90", "12", "91", "92",
      "12", "93", "12", "34", "94", "12", "95", "34", "12", "96", "34", "12", "97", "12", "98", "34",
      "12", "99", "9a", "12", "9b", "12", "9c", "9d", "9e", "9f", "a0", "a1", "a2", "12", "a3", "12",
      "34", "a4", "12", "a5", "34", "12", "a6", "a7", "12", "a8", "12", "a9", "34", "12", "aa", "a5",
      "91", "ab", "12", "ac", "34", "12", "ad", "12", "ae", "af", "b0", "12", "b1", "b2", "12", "b3",
      "12", "34", "b4", "12", "b5", "34", "12", "b6", "34", "12", "b7", "12", "b8", "34", "12", "b9",
      "ba", "12", "bb", "12", "bc", "bd", "be", "bf", "c0", "c1", "c2", "12", "c3", "12", "34", "c4",
      "12", "c5", "34", "12", "c6", "c7", "12", "c8", "12", "c9", "34", "12", "ca", "a5", "91", "cb",
      "12", "cc", "34", "12", "cd", "12", "ce", "cf", "d0", "12", "d1", "d2", "12", "d3", "12", "34",
      "d4", "12", "d5", "34", "12", "d6", "34", "12", "d7", "12", "d8", "12", "d9", "12", "da", "12",
      "db", "12", "dc", "dd", "de", "12", "34", "df", "e0", "e1", "e2", "12", "e3", "12", "34", "e4",
      "12", "e5", "34", "12", "e6", "e7", "12", "e8", "12", "e9", "34", "12", "ea", "a5", "91", "eb",
      "12", "ec", "34", "12", "ed", "ee", "ef", "f0", "12", "f1", "f2", "12", "f3", "12", "34", "f4",
      "12", "f5", "34", "12", "f6", "34", "12", "f7", "12", "f8", "12", "f9", "12", "fa", "34", "12",
      "fb", "12", "fc", "fd", "fe", "12", "ff"]
    end

    RSpec::Support::ObjectFormatter.default_instance.max_formatted_output_length = 10000000000000000

    before do
      mini_asm.instance_variable_set(:@memory, memory)
      mini_asm.instance_variable_set(:@cpu, :spc700)
    end

    it 'disassembles correctly' do
      expect(subject).to eq [
        "00/0000: 00                    NOP",
        "00/0001: 01                    TCALL 0",
        "00/0002: 02 12                 SET1  12.0",
        "00/0004: 03 12 34              BBS   12.0,003B {+34}",
        "00/0007: 04 12                 OR    A,12",
        "00/0009: 05 34 12              OR    A,!1234",
        "00/000C: 06                    OR    A,(X)",
        "00/000D: 07 12                 OR    A,[12+X]",
        "00/000F: 08 12                 OR    A,#12",
        "00/0011: 09 34 12              OR    12<d>,34<s>",
        "00/0014: 0a a5 91              OR1   C,1234.5",
        "00/0017: 0b 12                 ASL   12",
        "00/0019: 0c 34 12              ASL   !1234",
        "00/001C: 0d                    PUSH  PSW",
        "00/001D: 0e 34 12              TSET1 !1234",
        "00/0020: 0f                    BRK",
        "00/0021: 10 12                 BPL   0035 {+12}",
        "00/0023: 11                    TCALL 1",
        "00/0024: 12 12                 CLR1  12.0",
        "00/0026: 13 12 34              BBC   12.0,005D {+34}",
        "00/0029: 14 12                 OR    A,12+X",
        "00/002B: 15 34 12              OR    A,!1234+X",
        "00/002E: 16 34 12              OR    A,!1234+Y",
        "00/0031: 17 12                 OR    A,[12]+Y",
        "00/0033: 18 34 12              OR    12,#34",
        "00/0036: 19                    OR    (X),(Y)",
        "00/0037: 1a 12                 DECW  12",
        "00/0039: 1b 12                 ASL   12+X",
        "00/003B: 1c                    ASL   A",
        "00/003C: 1d                    DEC   X",
        "00/003D: 1e 34 12              CMP   X,!1234",
        "00/0040: 1f 34 12              JMP   [!1234+X]",
        "00/0043: 20                    CLRP",
        "00/0044: 21                    TCALL 2",
        "00/0045: 22 12                 SET1  12.1",
        "00/0047: 23 12 34              BBS   12.1,007E {+34}",
        "00/004A: 24 12                 AND   A,12",
        "00/004C: 25 34 12              AND   A,!1234",
        "00/004F: 26                    AND   A,(X)",
        "00/0050: 27 12                 AND   A,[12+X]",
        "00/0052: 28 12                 AND   A,#12",
        "00/0054: 29 34 12              AND   12<d>,34<s>",
        "00/0057: 2a a5 91              OR1   C,/1234.5",
        "00/005A: 2b 12                 ROL   12",
        "00/005C: 2c 34 12              ROL   !1234",
        "00/005F: 2d                    PUSH  A",
        "00/0060: 2e 12 34              CBNE  12,0097 {+34}",
        "00/0063: 2f 12                 BRA   0077 {+12}",
        "00/0065: 30 12                 BMI   0079 {+12}",
        "00/0067: 31                    TCALL 3",
        "00/0068: 32 12                 CLR1  12.1",
        "00/006A: 33 12 34              BBC   12.1,00A1 {+34}",
        "00/006D: 34 12                 AND   A,12+X",
        "00/006F: 35 34 12              AND   A,!1234+X",
        "00/0072: 36 34 12              AND   A,!1234+Y",
        "00/0075: 37 12                 AND   A,[12]+Y",
        "00/0077: 38 34 12              AND   12,#34",
        "00/007A: 39                    AND   (X),(Y)",
        "00/007B: 3a 12                 INCW  12",
        "00/007D: 3b 12                 ROL   12+X",
        "00/007F: 3c                    ROL   A",
        "00/0080: 3d                    INC   X",
        "00/0081: 3e 12                 CMP   X,12",
        "00/0083: 3f 34 12              CALL  !1234",
        "00/0086: 40                    SETP",
        "00/0087: 41                    TCALL 4",
        "00/0088: 42 12                 SET1  12.2",
        "00/008A: 43 12 34              BBS   12.2,00C1 {+34}",
        "00/008D: 44 12                 EOR   A,12",
        "00/008F: 45 34 12              EOR   A,!1234",
        "00/0092: 46                    EOR   A,(X)",
        "00/0093: 47 12                 EOR   A,[12+X]",
        "00/0095: 48 12                 EOR   A,#12",
        "00/0097: 49 34 12              EOR   12<d>,34<s>",
        "00/009A: 4a a5 91              AND1  C,1234.5",
        "00/009D: 4b 12                 LSR   12",
        "00/009F: 4c 34 12              LSR   !1234",
        "00/00A2: 4d                    PUSH  X",
        "00/00A3: 4e 34 12              TCLR1 !1234",
        "00/00A6: 4f 12                 PCALL 12",
        "00/00A8: 50 12                 BVC   00BC {+12}",
        "00/00AA: 51                    TCALL 5",
        "00/00AB: 52 12                 CLR1  12.2",
        "00/00AD: 53 12 34              BBC   12.2,00E4 {+34}",
        "00/00B0: 54 12                 EOR   A,12+X",
        "00/00B2: 55 34 12              EOR   A,!1234+X",
        "00/00B5: 56 34 12              EOR   A,!1234+Y",
        "00/00B8: 57 12                 EOR   A,[12]+Y",
        "00/00BA: 58 34 12              EOR   12,#34",
        "00/00BD: 59                    EOR   (X),(Y)",
        "00/00BE: 5a 12                 CMPW  YA,12",
        "00/00C0: 5b 12                 LSR   12+X",
        "00/00C2: 5c                    LSR   A",
        "00/00C3: 5d                    MOV   X,A",
        "00/00C4: 5e 34 12              CMP   Y,!1234",
        "00/00C7: 5f 34 12              JMP   !1234",
        "00/00CA: 60                    CLRC",
        "00/00CB: 61                    TCALL 6",
        "00/00CC: 62 12                 SET1  12.3",
        "00/00CE: 63 12 34              BBS   12.3,0105 {+34}",
        "00/00D1: 64 12                 CMP   A,12",
        "00/00D3: 65 34 12              CMP   A,!1234",
        "00/00D6: 66                    CMP   A,(X)",
        "00/00D7: 67 12                 CMP   A,[12+X]",
        "00/00D9: 68 12                 CMP   A,#12",
        "00/00DB: 69 34 12              CMP   12<d>,34<s>",
        "00/00DE: 6a a5 91              AND1  C,/1234.5",
        "00/00E1: 6b 12                 ROR   12",
        "00/00E3: 6c 34 12              ROR   !1234",
        "00/00E6: 6d                    PUSH  Y",
        "00/00E7: 6e 12 34              DBNZ  12,011E {+34}",
        "00/00EA: 6f                    RET",
        "00/00EB: 70 12                 BVS   00FF {+12}",
        "00/00ED: 71                    TCALL 7",
        "00/00EE: 72 12                 CLR1  12.3",
        "00/00F0: 73 12 34              BBC   12.3,0127 {+34}",
        "00/00F3: 74 12                 CMP   A,12+X",
        "00/00F5: 75 34 12              CMP   A,!1234+X",
        "00/00F8: 76 34 12              CMP   A,!1234+Y",
        "00/00FB: 77 12                 CMP   A,[12]+Y",
        "00/00FD: 78 34 12              CMP   12,#34",
        "00/0100: 79                    CMP   (X),(Y)",
        "00/0101: 7a 12                 ADDW  YA,12",
        "00/0103: 7b 12                 ROR   12+X",
        "00/0105: 7c                    ROR   A",
        "00/0106: 7d                    MOV   A,X",
        "00/0107: 7e 12                 CMP   Y,12",
        "00/0109: 7f                    RETI",
        "00/010A: 80                    SETC",
        "00/010B: 81                    TCALL 8",
        "00/010C: 82 12                 SET1  12.4",
        "00/010E: 83 12 34              BBS   12.4,0145 {+34}",
        "00/0111: 84 12                 ADC   A,12",
        "00/0113: 85 34 12              ADC   A,!1234",
        "00/0116: 86                    ADC   A,(X)",
        "00/0117: 87 12                 ADC   A,[12+X]",
        "00/0119: 88 12                 ADC   A,#12",
        "00/011B: 89 34 12              ADC   12<d>,34<s>",
        "00/011E: 8a a5 91              EOR1  C,1234.5",
        "00/0121: 8b 12                 DEC   12",
        "00/0123: 8c 34 12              DEC   !1234",
        "00/0126: 8d 12                 MOV   Y,#12",
        "00/0128: 8e                    POP   PSW",
        "00/0129: 8f 34 12              MOV   12,#34",
        "00/012C: 90 12                 BCC   0140 {+12}",
        "00/012E: 91                    TCALL 9",
        "00/012F: 92 12                 CLR1  12.4",
        "00/0131: 93 12 34              BBC   12.4,0168 {+34}",
        "00/0134: 94 12                 ADC   A,12+X",
        "00/0136: 95 34 12              ADC   A,!1234+X",
        "00/0139: 96 34 12              ADC   A,!1234+Y",
        "00/013C: 97 12                 ADC   A,[12]+Y",
        "00/013E: 98 34 12              ADC   12,#34",
        "00/0141: 99                    ADC   (X),(Y)",
        "00/0142: 9a 12                 SUBW  YA,12",
        "00/0144: 9b 12                 DEC   12+X",
        "00/0146: 9c                    DEC   A",
        "00/0147: 9d                    MOV   X,SP",
        "00/0148: 9e                    DIV   YA,X",
        "00/0149: 9f                    XCN   A",
        "00/014A: a0                    EI",
        "00/014B: a1                    TCALL 10",
        "00/014C: a2 12                 SET1  12.5",
        "00/014E: a3 12 34              BBS   12.5,0185 {+34}",
        "00/0151: a4 12                 SBC   A,12",
        "00/0153: a5 34 12              SBC   A,!1234",
        "00/0156: a6                    SBC   A,(X)",
        "00/0157: a7 12                 SBC   A,[12+X]",
        "00/0159: a8 12                 SBC   A,#12",
        "00/015B: a9 34 12              SBC   12<d>,34<s>",
        "00/015E: aa a5 91              MOV1  C,1234.5",
        "00/0161: ab 12                 INC   12",
        "00/0163: ac 34 12              INC   !1234",
        "00/0166: ad 12                 CMP   Y,#12",
        "00/0168: ae                    POP   A",
        "00/0169: af                    MOV   (X)+,A",
        "00/016A: b0 12                 BCS   017E {+12}",
        "00/016C: b1                    TCALL 11",
        "00/016D: b2 12                 CLR1  12.5",
        "00/016F: b3 12 34              BBC   12.5,01A6 {+34}",
        "00/0172: b4 12                 SBC   A,12+X",
        "00/0174: b5 34 12              SBC   A,!1234+X",
        "00/0177: b6 34 12              SBC   A,!1234+Y",
        "00/017A: b7 12                 SBC   A,[12]+Y",
        "00/017C: b8 34 12              SBC   12,#34",
        "00/017F: b9                    SBC   (X),(Y)",
        "00/0180: ba 12                 MOVW  YA,12",
        "00/0182: bb 12                 INC   12+X",
        "00/0184: bc                    INC   A",
        "00/0185: bd                    MOV   SP,X",
        "00/0186: be                    DAS   A",
        "00/0187: bf                    MOV   A,(X)+",
        "00/0188: c0                    DI",
        "00/0189: c1                    TCALL 12",
        "00/018A: c2 12                 SET1  12.6",
        "00/018C: c3 12 34              BBS   12.6,01C3 {+34}",
        "00/018F: c4 12                 MOV   12,A",
        "00/0191: c5 34 12              MOV   !1234,A",
        "00/0194: c6                    MOV   (X),A",
        "00/0195: c7 12                 MOV   [12+X],A",
        "00/0197: c8 12                 CMP   X,#12",
        "00/0199: c9 34 12              MOV   !1234,X",
        "00/019C: ca a5 91              MOV1  1234.5,C",
        "00/019F: cb 12                 MOV   12,Y",
        "00/01A1: cc 34 12              MOV   !1234,Y",
        "00/01A4: cd 12                 MOV   X,#12",
        "00/01A6: ce                    POP   X",
        "00/01A7: cf                    MUL   YA",
        "00/01A8: d0 12                 BNE   01BC {+12}",
        "00/01AA: d1                    TCALL 13",
        "00/01AB: d2 12                 CLR1  12.6",
        "00/01AD: d3 12 34              BBC   12.6,01E4 {+34}",
        "00/01B0: d4 12                 MOV   12+X,A",
        "00/01B2: d5 34 12              MOV   !1234+X,A",
        "00/01B5: d6 34 12              MOV   !1234+Y,A",
        "00/01B8: d7 12                 MOV   [12]+Y,A",
        "00/01BA: d8 12                 MOV   12,X",
        "00/01BC: d9 12                 MOV   12+Y,X",
        "00/01BE: da 12                 MOVW  12,YA",
        "00/01C0: db 12                 MOV   12+X,Y",
        "00/01C2: dc                    DEC   Y",
        "00/01C3: dd                    MOV   A,Y",
        "00/01C4: de 12 34              CBNE  12+X,01FB {+34}",
        "00/01C7: df                    DAA   A",
        "00/01C8: e0                    CLRV",
        "00/01C9: e1                    TCALL 14",
        "00/01CA: e2 12                 SET1  12.7",
        "00/01CC: e3 12 34              BBS   12.7,0203 {+34}",
        "00/01CF: e4 12                 MOV   A,12",
        "00/01D1: e5 34 12              MOV   A,!1234",
        "00/01D4: e6                    MOV   A,(X)",
        "00/01D5: e7 12                 MOV   A,[12+X]",
        "00/01D7: e8 12                 MOV   A,#12",
        "00/01D9: e9 34 12              MOV   X,!1234",
        "00/01DC: ea a5 91              NOT1  1234.5",
        "00/01DF: eb 12                 MOV   Y,12",
        "00/01E1: ec 34 12              MOV   Y,!1234",
        "00/01E4: ed                    NOTC",
        "00/01E5: ee                    POP   Y",
        "00/01E6: ef                    SLEEP",
        "00/01E7: f0 12                 BEQ   01FB {+12}",
        "00/01E9: f1                    TCALL 15",
        "00/01EA: f2 12                 CLR1  12.7",
        "00/01EC: f3 12 34              BBC   12.7,0223 {+34}",
        "00/01EF: f4 12                 MOV   A,12+X",
        "00/01F1: f5 34 12              MOV   A,!1234+X",
        "00/01F4: f6 34 12              MOV   A,!1234+Y",
        "00/01F7: f7 12                 MOV   A,[12]+Y",
        "00/01F9: f8 12                 MOV   X,12",
        "00/01FB: f9 12                 MOV   X,12+Y",
        "00/01FD: fa 34 12              MOV   12<d>,34<s>",
        "00/0200: fb 12                 MOV   Y,12+X",
        "00/0202: fc                    INC   Y",
        "00/0203: fd                    MOV   Y,A",
        "00/0204: fe 12                 DBNZ  Y,0218 {+12}",
        "00/0206: ff                    STOP"
      ]
    end
  end
end